/*! boardful-core 2015-07-03 */
var BOARDFUL=BOARDFUL||{};BOARDFUL.core=BOARDFUL.core||{},BOARDFUL.core.Namespace=function(a){var b=a.split("."),c=window;for(var d in b)void 0===c[b[d]]&&(c[b[d]]={}),c=c[b[d]];return c},BOARDFUL.core.Init=function(a){BOARDFUL.core.checkEnvi(),BOARDFUL.Logger=new BOARDFUL.core.Logger,BOARDFUL.Logger.add(winston.transports.File,{filename:"logs/boardful.log"}).remove(winston.transports.Console),BOARDFUL.Logger.log("info","----------launch----------"),BOARDFUL.Debugger=new BOARDFUL.core.Logger,BOARDFUL.Debugger.add(winston.transports.File,{filename:"logs/debug.log"}).remove(winston.transports.Console),BOARDFUL.Debugger.log("info","----------launch----------"),BOARDFUL.Logger.log("info","launch type",a),BOARDFUL.Logger.log("info","environment",BOARDFUL.core.Envi),BOARDFUL.core.UrlParam=BOARDFUL.core.parseUrl(),BOARDFUL.Logger.log("info","url param",BOARDFUL.core.UrlParam),BOARDFUL.Mngr=new BOARDFUL.core.Manager,BOARDFUL.FileMngr=new BOARDFUL.core.FileManager},BOARDFUL.core.runBoard=function(a){BOARDFUL.FileMngr.load([a],function(b){BOARDFUL.Game=new BOARDFUL.core.Game(b[a]),BOARDFUL.Game.run()})},BOARDFUL.core.Namespace("BOARDFUL.core"),BOARDFUL.core.BoardLoader=function(a,b){this.board=a||{},void 0!==a.dependency?this.loadDependency(a.dependency):this.loadComponents(a.files)},BOARDFUL.core.BoardLoader.prototype.loadDependency=function(a){var b=this;BOARDFUL.FileMngr.load(a,function(){b.loadComponents()})},BOARDFUL.core.BoardLoader.prototype.loadComponents=function(a){var b=this;void 0!==board.files?BOARDFUL.FileMngr.load(a,function(){BOARDFUL.Game=new BOARDFUL.core.Game(b.board)}):BOARDFUL.Game=new BOARDFUL.core.Game(this.board)},BOARDFUL.core.Namespace("BOARDFUL.core"),BOARDFUL.core.Deck=function(a,b){this.type="Deck",this.owner=a,BOARDFUL.Mngr.add(this),this.config=b||{},this.card_list={},this.addListeners()},BOARDFUL.core.Deck.prototype.addListeners=function(){var a=this;"draw"===this.config.name&&BOARDFUL.EventMngr.on("InitCards",{level:"game",callback:function(b){a.initCards(b)},id:a.id})},BOARDFUL.core.Deck.prototype.initCards=function(a){var b=BOARDFUL.Mngr.get(this.owner).player_list,c=[];for(var d in b){var e=new BOARDFUL.core.Event({name:"CardsDraw",target:b[d],number:a.number});c.push(e.id)}BOARDFUL.EventMngr.front(c)},BOARDFUL.core.Namespace("BOARDFUL.core"),BOARDFUL.core.Event=function(a){this.type="Event",this.owner=void 0,BOARDFUL.Mngr.add(this),this.name=a.name,this.arg=a,this.arg.creation_time=new Date},BOARDFUL.core.EVENT_LEVELS=["top","system","server","board","room","game","extension","player","card","rear"],BOARDFUL.core.EventManager=function(a,b){this.type="EventManager",this.owner=a,BOARDFUL.Mngr.add(this),this.config=b||{},this.current=void 0,this.list=new Array,this.listener_list=new Object,this.config.timeout=20,this.logger=new BOARDFUL.core.Logger,this.logger.add(winston.transports.File,{filename:"logs/event.log"}).remove(winston.transports.Console),this.logger.log("info","----------launch----------"),this.name_logger=new BOARDFUL.core.Logger,this.name_logger.add(winston.transports.File,{filename:"logs/event_name.log"}),this.name_logger.log("info","----------launch----------")},BOARDFUL.core.EventManager.prototype.front=function(a){if(void 0===a){if(0==this.list.length)return void 0}else if("array"==typeof a||"object"==typeof a){this.list=a.concat(this.list);for(var b in a)this.logger.log("info","prepend events",BOARDFUL.Mngr.get(a[b]).name)}else this.list.unshift(a),this.logger.log("info","prepend event",BOARDFUL.Mngr.get(a).name);return BOARDFUL.Mngr.get(this.list[0])},BOARDFUL.core.EventManager.prototype.add=function(a){if("array"==typeof a||"object"==typeof a){this.list=this.list.concat(a);for(var b in a)this.logger.log("info","append events",BOARDFUL.Mngr.get(a[b]).name)}else this.list.push(a),this.logger.log("info","append event",BOARDFUL.Mngr.get(a).name)},BOARDFUL.core.EventManager.prototype.on=function(a,b){a in this.listener_list||(this.listener_list[a]=new Object),b.level=b.level||"rear",b.level in this.listener_list[a]||(this.listener_list[a][b.level]=new Array),this.listener_list[a][b.level].push(b),this.logger.log("info","add listener",a)},BOARDFUL.core.EventManager.prototype.off=function(a,b){if(a in this.listener_list&&(b.level=b.level||"extension",b.level in this.listener_list[a])){var c=this.listener_list[a][b.level].indexOf(b);c>=0&&this.listener_list[a][b.level].splice(c,1)}},BOARDFUL.core.EventManager.prototype.run=function(){switch(BOARDFUL.Game.status){case"pause":case"exit":case"userinput":case"uieffect":break;case"run":default:if(this.list.length>0&&(this.current=this.front(),this.logger.log("info","event",this.current.name,this.current),this.name_logger.log("info",this.current.name),this.list.shift(),this.current&&this.current.name in this.listener_list))for(var a in BOARDFUL.core.EVENT_LEVELS)if(BOARDFUL.core.EVENT_LEVELS[a]in this.listener_list[this.current.name])for(var b in this.listener_list[this.current.name][BOARDFUL.core.EVENT_LEVELS[a]]){var c=this.listener_list[this.current.name][BOARDFUL.core.EVENT_LEVELS[a]][b];this.logger.log("info","listener",BOARDFUL.Mngr.get(c.id).name),c.callback(this.current.arg)}}var d=this;setTimeout(function(){d.run()},this.config.timeout)},BOARDFUL.core.Namespace("BOARDFUL.core"),BOARDFUL.core.FileLoader=function(a,b,c){this.mngr=a,this.list=b,this.callback=c,this.done=!1,this.load()},BOARDFUL.core.FileLoader.prototype.load=function(){this.done=!0;for(var a in this.list)this.list[a]in this.mngr.name_list&&"loaded"==this.mngr.list[this.mngr.name_list[this.list[a]]].status||(this.done=!1,this.loadFile(this.list[a]));var b=this;if(this.done){var c={};for(var a in this.list)c[this.list[a]]=this.mngr.list[this.mngr.name_list[this.list[a]]].content;this.callback(c)}else setTimeout(function(){b.load()},500)},BOARDFUL.core.FileLoader.prototype.loadFile=function(a){switch(BOARDFUL.core.Envi.type){case"browser":this.loadByAjax(a);break;case"nodejs":this.loadByRequire(a)}},BOARDFUL.core.FileLoader.prototype.loadByRequire=function(a){try{var b=require("../"+a);this.mngr.add(a,b,"loaded"),this.mngr.logger.log("info","file loaded",a)}catch(c){this.mngr.add(a,"","failed"),this.mngr.logger.log("info","file failed",a,c)}},BOARDFUL.core.FileLoader.prototype.loadByAjax=function(a){var b=this,c="./"+a;".js"==a.substr(a.length-3)?$.getScript(c).done(function(c,d){b.mngr.add(a,c,"loaded"),b.mngr.logger.log("info","js loaded",a)}).fail(function(c,d,e){b.mngr.add(a,"","failed"),b.mngr.logger.log("info","js failed",a)}):".css"==a.substr(a.length-4)?($("head").append($('<link rel="stylesheet" type="text/css" />').attr("href",c)),this.mngr.add(a,"","loaded"),this.mngr.logger.log("info","css loaded",a)):".json"==a.substr(a.length-5)?$.getJSON(c,function(c,d,e){b.mngr.add(a,c,"loaded"),b.mngr.logger.log("info","json loaded",a)}).fail(function(c,d,e){b.mngr.add(a,"","failed"),b.mngr.logger.log("info","json failed",a,d,e)}).always(function(a,b,c){}):(this.mngr.add(a,"","loaded"),this.mngr.logger.log("info","file unknown",a))},BOARDFUL.core.Namespace("BOARDFUL.core"),BOARDFUL.core.FileManager=function(){this.list=[],this.name_list={},this.next_id=0,this.logger=new BOARDFUL.core.Logger,this.logger.add(winston.transports.File,{filename:"logs/file.log"}).remove(winston.transports.Console),this.logger.log("info","----------launch----------")},BOARDFUL.core.FileManager.prototype.load=function(a,b){new BOARDFUL.core.FileLoader(this,a,b)},BOARDFUL.core.FileManager.prototype.add=function(a,b,c){a in this.name_list?this.list[this.name_list[a]]={name:a,content:b,status:c}:(this.list[this.next_id]={name:a,type:"",content:b,status:c},this.name_list[a]=this.next_id,++this.next_id)},BOARDFUL.core.FileManager.prototype.getFromHtml=function(){$("script").each(function(){this.add($(this).attr("src"),$(this),"loaded")}),this.logger.log("info","files in html",this.name_list)},BOARDFUL.core.Namespace("BOARDFUL.core"),BOARDFUL.core.Game=function(a,b){this.type="Game",this.owner=void 0,BOARDFUL.Mngr.add(this),this.board=a||{},this.config=b||{},this.table_list={},this.deck_list={},this.player_list={},this.cardset_list={},BOARDFUL.EventMngr=new BOARDFUL.core.EventManager,this.addListeners()},BOARDFUL.core.Game.prototype.addListeners=function(){var a=this;BOARDFUL.EventMngr.on("GameInit",{level:"game",callback:function(b){a.gameInit(b)},id:a.id}),BOARDFUL.EventMngr.on("TableCreate",{level:"game",callback:function(b){a.tableCreate(b)},id:a.id}),BOARDFUL.EventMngr.on("DeckCreate",{level:"game",callback:function(b){a.deckCreate(b)},id:a.id}),BOARDFUL.EventMngr.on("PlayerCreate",{level:"game",callback:function(b){a.playerCreate(b)},id:a.id}),BOARDFUL.EventMngr.on("CardSetCreate",{level:"game",callback:function(b){a.cardSetCreate(b)},id:a.id}),BOARDFUL.EventMngr.on("GameStart",{level:"game",callback:function(b){a.gameStart(b)},id:a.id})},BOARDFUL.core.Game.prototype.run=function(){BOARDFUL.Game.status="run",BOARDFUL.EventMngr.run();var a=[],b=new BOARDFUL.core.Event({name:"GameInit"});a.push(b.id),BOARDFUL.EventMngr.front(a)},BOARDFUL.core.Game.prototype.gameInit=function(a){this.board.board=this.board.board||{};var b=[];if(void 0!==this.board.board.tables)for(var c=parseInt(this.board.board.tables.number),d=0;c>d;++d){var e=new BOARDFUL.core.Event({name:"TableCreate",target:this.board.board.tables.names[d]});b.push(e.id)}if(void 0!==this.board.board.decks)for(var f=parseInt(this.board.board.decks.number),d=0;f>d;++d){var e=new BOARDFUL.core.Event({name:"DeckCreate",target:this.board.board.decks.names[d]});b.push(e.id)}if(void 0!==this.board.board.players)for(var g=parseInt(this.board.board.players.number),d=0;g>d;++d){var e=new BOARDFUL.core.Event({name:"PlayerCreate",target:this.board.board.players.names[d]});b.push(e.id)}if(void 0!==this.board.board.cardSets)for(var h=parseInt(this.board.board.cardSets.number),d=0;h>d;++d){var e=new BOARDFUL.core.Event({name:"CardSetCreate",target:this.board.board.cardSets.namespaces[d]});b.push(e.id)}var e=new BOARDFUL.core.Event({name:"GameStart"});b.push(e.id),BOARDFUL.EventMngr.front(b)},BOARDFUL.core.Game.prototype.tableCreate=function(a){this.table_list[a.target]=new BOARDFUL.core.Table(this.id,{name:a.target})},BOARDFUL.core.Game.prototype.deckCreate=function(a){this.deck_list[a.target]=new BOARDFUL.core.Deck(this.id,{name:a.target})},BOARDFUL.core.Game.prototype.playerCreate=function(a){this.player_list[a.target]=new BOARDFUL.core.Player(this.id,{name:a.target})},BOARDFUL.core.Game.prototype.cardSetCreate=function(a){},BOARDFUL.core.Game.prototype.gameStart=function(a){this.board.flow=this.board.flow||{};var b=[];if(void 0!==this.board.flow.initCards){var c=new BOARDFUL.core.Event({name:"InitCards",number:this.board.flow.initCards});b.push(c.id)}if(void 0!==this.board.flow.roundAction){var c=new BOARDFUL.core.Event({name:"RoundActionStart"});if(b.push(c.id),void 0!==this.board.flow.roundAction.drawPhase){var c=new BOARDFUL.core.Event({name:"RoundActionDrawPhase",number:this.board.flow.roundAction.drawPhase});b.push(c.id)}if(void 0!==this.board.flow.roundAction.playPhase){var c=new BOARDFUL.core.Event({name:"RoundActionPlayPhase",number:this.board.flow.roundAction.playPhase});b.push(c.id)}if(void 0!==this.board.flow.roundAction.endPhase){var c=new BOARDFUL.core.Event({name:"RoundActionEndPhase",number:this.board.flow.roundAction.endPhase});b.push(c.id)}var c=new BOARDFUL.core.Event({name:"RoundActionEnd"});b.push(c.id)}if(void 0!==this.board.flow.playerAction){var c=new BOARDFUL.core.Event({name:"playerActionStart"});b.push(c.id);var c=new BOARDFUL.core.Event({name:"playerActionEnd"});b.push(c.id)}BOARDFUL.EventMngr.front(b)},BOARDFUL.core.Namespace("BOARDFUL.core");var winston={transports:{File:"File",Console:"Console"}};BOARDFUL.core.Logger=function(){var a;switch(BOARDFUL.core.Envi.type){case"nodejs":winston=require("winston"),a=new BOARDFUL.core.WinstonLogger({transports:[new winston.transports.Console]});break;case"browser":a=new BOARDFUL.core.DefaultLogger;break;default:a=new BOARDFUL.core.DefaultLogger}return a},BOARDFUL.core.DefaultLogger=function(){this.enable=!0,this.list=new Array},BOARDFUL.core.DefaultLogger.prototype.log=function(){var a="";for(var b in arguments)a+="array"==typeof arguments[b]||"object"==typeof arguments[b]||"function"==typeof arguments[b]?BOARDFUL.core.toString(arguments[b]):arguments[b],a+=" ";return this.list.push({time:new Date,content:a}),this.enable&&console.log.apply(console,arguments),this},BOARDFUL.core.DefaultLogger.prototype.add=function(a){return"Console"==a&&(this.enable=!0),this},BOARDFUL.core.DefaultLogger.prototype.remove=function(a){return"Console"==a&&(this.enable=!1),this},BOARDFUL.core.WinstonLogger=function(a){return this.winston=new winston.Logger(a),this.winston.log_base=this.winston.log,this.winston.log=function(){if("nodejs"==BOARDFUL.core.Envi.type)for(var a in arguments)("array"==typeof arguments[a]||"object"==typeof arguments[a]||"function"==typeof arguments[a])&&(arguments[a]=BOARDFUL.core.toString(arguments[a]));return this.log_base.apply(this,arguments)},this.winston},BOARDFUL.core.Namespace("BOARDFUL.core"),BOARDFUL.core.Manager=function(){this.logger=new BOARDFUL.core.Logger,this.logger.add(winston.transports.File,{filename:"logs/mngr.log"}).remove(winston.transports.Console),this.logger.log("info","----------launch----------"),this.next_id=0,this.list=new Object},BOARDFUL.core.Manager.prototype.get=function(a){return this.list[a]},BOARDFUL.core.Manager.prototype.add=function(a){return a.id=this.next_id,a.type=a.type||a.constructor.name,"name"in a||(a.name=a.type+"_"+a.id),++this.next_id,this.list[a.id]=a,this.logger.log("info","add",a.name,a),a.id},BOARDFUL.core.Namespace("BOARDFUL.core"),BOARDFUL.core.Envi=new Object,BOARDFUL.core.checkEnvi=function(){"undefined"!=typeof module&&module.exports?BOARDFUL.core.Envi.type="nodejs":(BOARDFUL.core.Envi.type="browser",BOARDFUL.core.Envi.isOpera=!!window.opera||navigator.userAgent.indexOf(" OPR/")>=0,BOARDFUL.core.Envi.isFirefox="undefined"!=typeof InstallTrigger,BOARDFUL.core.Envi.isSafari=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0,BOARDFUL.core.Envi.isChrome=!!window.chrome&&!BOARDFUL.core.Envi.isOpera,BOARDFUL.core.Envi.isIE=!1||!!document.documentMode)},BOARDFUL.core.parseUrlParam=function(a){for(var b={},a=a||window.location.search.substring(1),c=a.split("&"),d=0;d<c.length;d++){var e=c[d].split("=");if("undefined"==typeof b[e[0]])b[e[0]]=e[1];else if("string"==typeof b[e[0]]){var f=[b[e[0]],e[1]];b[e[0]]=f}else b[e[0]].push(e[1])}return b},BOARDFUL.core.parseUrl=function(){var a=BOARDFUL.core.parseUrlParam(window.location.search.substring(1));a["#"]=window.location.hash.substring(1);var b=BOARDFUL.core.parseUrlParam(window.location.hash.substring(1));for(var c in b)c in a||(a[c]=b[c]);return a},BOARDFUL.core.Namespace("BOARDFUL.core"),BOARDFUL.core.Player=function(a,b){this.type="Player",this.owner=void 0,BOARDFUL.Mngr.add(this),this.config=b||{},this.card_list={},this.addListeners()},BOARDFUL.core.Player.prototype.addListeners=function(){},BOARDFUL.core.Namespace("BOARDFUL.core"),BOARDFUL.core.Table=function(a,b){this.type="Table",this.owner=void 0,BOARDFUL.Mngr.add(this),this.config=b||{},this.card_list={},this.addListeners()},BOARDFUL.core.Table.prototype.addListeners=function(){},BOARDFUL.core.Namespace("BOARDFUL.core"),BOARDFUL.core.getFunctionFromString=function(a){var b=window,c=a.split(".");for(i=0;i<c.length-1;i++)if(b=b[c[i]],void 0==b)return;return b[c[c.length-1]]},BOARDFUL.core.toString=function(a){var b=a;try{b=JSON.stringify(a)}catch(c){if("array"==typeof a||"object"==typeof a||"function"==typeof a){b="{";for(var d in a){if(b+=d+":","array"==typeof a[d]||"object"==typeof a[d]||"function"==typeof a[d]){b+="{";for(var e in a[d])b+=e+":",b+="array"==typeof a[d][e]||"object"==typeof a[d][e]||"function"==typeof a[e]?typeof a[d][e]:a[d][e],b+=",";b+="}"}else b+=a[d];b+=","}b+="}"}else b=""+a}return b},BOARDFUL.core.shuffle=function(a){for(var b,c,d=a.length;d;b=Math.floor(Math.random()*d),c=a[--d],a[d]=a[b],a[b]=c);return a};