/*! boardful-core 2015-06-27 */
var BOARDFUL=BOARDFUL||{};BOARDFUL.core=BOARDFUL.core||{},BOARDFUL.core.Namespace=function(a){var b=a.split("."),c=window;for(var d in b)void 0===c[b[d]]&&(c[b[d]]={}),c=c[b[d]];return c},BOARDFUL.core.Init=function(){BOARDFUL.core.checkEnvi(),BOARDFUL.logger=new BOARDFUL.core.Logger,BOARDFUL.mngr=new BOARDFUL.core.Manager},BOARDFUL.core.Namespace("BOARDFUL.core"),BOARDFUL.Event=function(a){this.type="Event",this.owner=void 0,BOARDFUL.Mngr.add(this),this.name=a.name,this.arg=a,this.arg.creation_time=new Date},BOARDFUL.Event.LEVELS=["top","system","server","board","room","game","extension","player","card","rear"],BOARDFUL.core.EventManager=function(a,b){this.type="EventManager",this.owner=a,BOARDFUL.Mngr.add(this),this.config=b||{},this.current=void 0,this.list=new Array,this.listener_list=new Object,this.config.timeout=20,this.logger=new BOARDFUL.core.Logger,this.logger.add(winston.transports.File,{filename:"logs/event.log"}).remove(winston.transports.Console),this.logger.log("info","----------launch----------"),this.name_logger=new BOARDFUL.core.Logger,this.name_logger.add(winston.transports.File,{filename:"logs/event_name.log"}).remove(winston.transports.Console),this.name_logger.log("info","----------launch----------")},BOARDFUL.core.EventManager.prototype.front=function(a){if(void 0===a){if(0==this.list.length)return void 0}else if("array"==typeof a||"object"==typeof a){this.list=a.concat(this.list);for(var b in a)this.logger.log("info","prepend events",BOARDFUL.Mngr.get(a[b]).name)}else this.list.unshift(a),this.logger.log("info","prepend event",BOARDFUL.Mngr.get(a).name);return BOARDFUL.Mngr.get(this.list[0])},BOARDFUL.core.EventManager.prototype.add=function(a){if("array"==typeof a||"object"==typeof a){this.list=this.list.concat(a);for(var b in a)this.logger.log("info","append events",BOARDFUL.Mngr.get(a[b]).name)}else this.list.push(a),this.logger.log("info","append event",BOARDFUL.Mngr.get(a).name)},BOARDFUL.core.EventManager.prototype.on=function(a,b){a in this.listener_list||(this.listener_list[a]=new Object),b.level=b.level||"rear",b.level in this.listener_list[a]||(this.listener_list[a][b.level]=new Array),this.listener_list[a][b.level].push(b),this.logger.log("info","add listener",a)},BOARDFUL.core.EventManager.prototype.off=function(a,b){if(a in this.listener_list&&(b.level=b.level||"extension",b.level in this.listener_list[a])){var c=this.listener_list[a][b.level].indexOf(b);c>=0&&this.listener_list[a][b.level].splice(c,1)}},BOARDFUL.core.EventManager.prototype.run=function(){switch(BOARDFUL.Mngr.get(this.owner).status){case"pause":case"exit":case"userinput":case"uieffect":break;case"run":default:if(this.list.length>0&&(this.current=this.front(),this.logger.log("info","event",this.current.name,this.current),this.name_logger.log("info",this.current.name),this.list.shift(),this.current&&this.current.name in this.listener_list))for(var a in BOARDFUL.Event.LEVELS)if(BOARDFUL.Event.LEVELS[a]in this.listener_list[this.current.name])for(var b in this.listener_list[this.current.name][BOARDFUL.Event.LEVELS[a]]){var c=this.listener_list[this.current.name][BOARDFUL.Event.LEVELS[a]][b];this.logger.log("info","listener",BOARDFUL.Mngr.get(c.id).name),c.callback(this.current.arg)}}var d=this;setTimeout(function(){d.run()},this.config.timeout)},BOARDFUL.core.Namespace("BOARDFUL.core"),BOARDFUL.core.FileLoader=function(a,b){this.list=a,this.callback=b,this.done=!1,this.load()},BOARDFUL.core.FileLoader.prototype.load=function(){this.done=!0;for(var a in this.list)this.list[a]in BOARDFUL.File.name_list&&"loaded"==BOARDFUL.File.list[BOARDFUL.File.name_list[this.list[a]]].status||(this.done=!1,this.loadFile(this.list[a]));var b=this;this.done?this.callback():setTimeout(function(){b.load()},500)},BOARDFUL.core.FileLoader.prototype.loadFile=function(a){switch(BOARDFUL.Envi.type){case"browser":this.loadByAjax(a);break;case"nodejs":this.loadByRequire(a)}},BOARDFUL.core.FileLoader.prototype.loadByRequire=function(a){try{var b=require("../"+a);BOARDFUL.File.add(a,b,"loaded"),BOARDFUL.File.logger.log("info","file loaded",a)}catch(c){BOARDFUL.File.add(a,"","failed"),BOARDFUL.File.logger.log("info","file failed",a,c)}},BOARDFUL.core.FileLoader.prototype.loadByAjax=function(a){var b="../"+a;".js"==a.substr(a.length-3)?$.getScript(b).done(function(b,c){BOARDFUL.File.add(a,b,"loaded"),BOARDFUL.File.logger.log("info","js loaded",a)}).fail(function(b,c,d){BOARDFUL.File.add(a,"","failed"),BOARDFUL.File.logger.log("info","js failed",a)}):".css"==a.substr(a.length-4)?($("head").append($('<link rel="stylesheet" type="text/css" />').attr("href",b)),BOARDFUL.File.add(a,"","loaded"),BOARDFUL.File.logger.log("info","css loaded",a)):".json"==a.substr(a.length-5)?$.getJSON(b,function(b,c,d){BOARDFUL.File.add(a,b,"loaded"),BOARDFUL.File.logger.log("info","json loaded",a)}).fail(function(b,c,d){BOARDFUL.File.add(a,"","failed"),BOARDFUL.File.logger.log("info","json failed",a)}).always(function(a,b,c){}):(BOARDFUL.File.add(a,"","loaded"),BOARDFUL.File.logger.log("info","file unknown",a))},BOARDFUL.core.Namespace("BOARDFUL.core"),BOARDFUL.core.FileManager=function(){this.list=[],this.name_list={},this.next_id=0},BOARDFUL.core.FileManager.prototype.add=function(a,b,c){a in this.name_list?this.list[this.name_list[a]]={name:a,content:b,status:c}:(this.list[this.next_id]={name:a,type:"",content:b,status:c},this.name_list[a]=this.next_id,++this.next_id)},BOARDFUL.core.FileManager.prototype.getFromHtml=function(){$("script").each(function(){this.add($(this).attr("src"),$(this),"loaded")})},BOARDFUL.core.Namespace("BOARDFUL.core");var winston={transports:{File:"File",Console:"Console"}};BOARDFUL.core.Logger=function(){var a;switch(BOARDFUL.core.Envi.type){case"nodejs":winston=require("winston"),a=new BOARDFUL.core.WinstonLogger({transports:[new winston.transports.Console]});break;case"browser":a=new BOARDFUL.core.DefaultLogger;break;default:a=new BOARDFUL.core.DefaultLogger}return a},BOARDFUL.core.DefaultLogger=function(){this.enable=!0,this.list=new Array},BOARDFUL.core.DefaultLogger.prototype.log=function(){var a="";for(var b in arguments)a+="array"==typeof arguments[b]||"object"==typeof arguments[b]||"function"==typeof arguments[b]?BOARDFUL.core.toString(arguments[b]):arguments[b],a+=" ";return this.list.push({time:new Date,content:a}),this.enable&&console.log.apply(console,arguments),this},BOARDFUL.core.DefaultLogger.prototype.add=function(a){return"Console"==a&&(this.enable=!0),this},BOARDFUL.core.DefaultLogger.prototype.remove=function(a){return"Console"==a&&(this.enable=!1),this},BOARDFUL.core.WinstonLogger=function(a){return this.winston=new winston.Logger(a),this.winston.log_base=this.winston.log,this.winston.log=function(){if("nodejs"==BOARDFUL.core.Envi.type)for(var a in arguments)("array"==typeof arguments[a]||"object"==typeof arguments[a]||"function"==typeof arguments[a])&&(arguments[a]=BOARDFUL.core.toString(arguments[a]));return this.log_base.apply(this,arguments)},this.winston},BOARDFUL.core.Namespace("BOARDFUL.core"),BOARDFUL.core.Manager=function(){this.logger=new BOARDFUL.core.Logger,this.logger.add(winston.transports.File,{filename:"logs/mngr.log"}).remove(winston.transports.Console),this.logger.log("info","----------launch----------"),this.next_id=0,this.list=new Object},BOARDFUL.core.Manager.prototype.get=function(a){return this.list[a]},BOARDFUL.core.Manager.prototype.add=function(a){return a.id=this.next_id,a.type=a.type||a.constructor.name,"name"in a||(a.name=a.type+"_"+a.id),++this.next_id,this.list[a.id]=a,this.logger.log("info","add",a.name,a),a.id},BOARDFUL.core.Namespace("BOARDFUL.core"),BOARDFUL.core.Envi=new Object,BOARDFUL.core.checkEnvi=function(){"undefined"!=typeof module&&module.exports?BOARDFUL.core.Envi.type="nodejs":(BOARDFUL.core.Envi.type="browser",BOARDFUL.core.Envi.isOpera=!!window.opera||navigator.userAgent.indexOf(" OPR/")>=0,BOARDFUL.core.Envi.isFirefox="undefined"!=typeof InstallTrigger,BOARDFUL.core.Envi.isSafari=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0,BOARDFUL.core.Envi.isChrome=!!window.chrome&&!BOARDFUL.core.Envi.isOpera,BOARDFUL.core.Envi.isIE=!1||!!document.documentMode)},BOARDFUL.core.parseUrlParam=function(a){for(var b={},a=a||window.location.search.substring(1),c=a.split("&"),d=0;d<c.length;d++){var e=c[d].split("=");if("undefined"==typeof b[e[0]])b[e[0]]=e[1];else if("string"==typeof b[e[0]]){var f=[b[e[0]],e[1]];b[e[0]]=f}else b[e[0]].push(e[1])}return b},BOARDFUL.core.parseUrl=function(){var a=BOARDFUL.core.parseUrlParam(window.location.search.substring(1));a["#"]=window.location.hash.substring(1);var b=BOARDFUL.core.parseUrlParam(window.location.hash.substring(1));for(var c in b)c in a||(a[c]=b[c]);return a},BOARDFUL.core.Namespace("BOARDFUL.core"),BOARDFUL.core.getFunctionFromString=function(a){var b=window,c=a.split(".");for(i=0;i<c.length-1;i++)if(b=b[c[i]],void 0==b)return;return b[c[c.length-1]]},BOARDFUL.core.toString=function(a){var b=a;try{b=JSON.stringify(a)}catch(c){if("array"==typeof a||"object"==typeof a||"function"==typeof a){b="{";for(var d in a){if(b+=d+":","array"==typeof a[d]||"object"==typeof a[d]||"function"==typeof a[d]){b+="{";for(var e in a[d])b+=e+":",b+="array"==typeof a[d][e]||"object"==typeof a[d][e]||"function"==typeof a[e]?typeof a[d][e]:a[d][e],b+=",";b+="}"}else b+=a[d];b+=","}b+="}"}else b=""+a}return b},BOARDFUL.core.shuffle=function(a){for(var b,c,d=a.length;d;b=Math.floor(Math.random()*d),c=a[--d],a[d]=a[b],a[b]=c);return a};